name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      target:
        description: 'Publish target'
        required: true
        default: 'testpypi'
        type: choice
        options:
          - testpypi
          - pypi

jobs:
  build:
    name: Build wheels
    uses: ./.github/workflows/build-wheels.yml

  # TODO: Remove this job if TestPyPI is never needed
  publish-testpypi:
    name: Publish to TestPyPI
    needs: [build]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.target == 'testpypi'

    environment:
      name: testpypi
      url: https://test.pypi.org/p/pydqm

    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: List artifacts
        run: ls -la dist/

      # Uncomment after setting up TestPyPI trusted publishing
      # - name: Publish to TestPyPI
      #   uses: pypa/gh-action-pypi-publish@release/v1
      #   with:
      #     repository-url: https://test.pypi.org/legacy/
      #     packages-dir: dist/

      - name: TestPyPI placeholder
        run: |
          echo "============================================="
          echo "TestPyPI publishing is not yet configured."
          echo ""
          echo "To enable:"
          echo "1. Create account at https://test.pypi.org"
          echo "2. Add trusted publisher at https://test.pypi.org/manage/account/publishing/"
          echo "   - Project: pydqm"
          echo "   - Owner: zanderteller"
          echo "   - Repo: dqm"
          echo "   - Workflow: publish.yml"
          echo "   - Environment: testpypi"
          echo "3. Create 'testpypi' environment in GitHub repo settings"
          echo "4. Uncomment the publish step above"
          echo "============================================="
          ls -la dist/

  publish-pypi:
    name: Publish to PyPI
    needs: [build]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'release') ||
      (github.event_name == 'workflow_dispatch' && inputs.target == 'pypi')

    environment:
      name: pypi
      url: https://pypi.org/p/pydqm

    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: List artifacts
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
